"use strict";(self.webpackChunkcreate_project_docs=self.webpackChunkcreate_project_docs||[]).push([[6839],{28453:(e,s,n)=>{n.d(s,{R:()=>t,x:()=>i});var r=n(96540);const d={},c=r.createContext(d);function t(e){const s=r.useContext(c);return r.useMemo(function(){return"function"==typeof e?e(s):{...s,...e}},[s,e])}function i(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(d):e.components||d:t(e.components),r.createElement(c.Provider,{value:s},e.children)}},46762:(e,s,n)=>{n.r(s),n.d(s,{assets:()=>o,contentTitle:()=>i,default:()=>a,frontMatter:()=>t,metadata:()=>r,toc:()=>l});const r=JSON.parse('{"id":"internal-contracts/websocket","title":"WebSocket Events","description":"Socket.IO, same origin as Next.js. Client connects with io() (no args). Server defined in server.js. Redis-backed for cluster-aware rooms and code state persistence.","source":"@site/docs/internal-contracts/websocket.md","sourceDirName":"internal-contracts","slug":"/internal-contracts/websocket","permalink":"/project-code-battlegrounds-1-5/docs/internal-contracts/websocket","draft":false,"unlisted":false,"editUrl":"https://github.com/Capstone-Projects-2026-spring/project-code-battlegrounds-1-5/edit/main/documentation/docs/internal-contracts/websocket.md","tags":[],"version":"current","lastUpdatedBy":"samirbuch","sidebarPosition":8,"frontMatter":{"sidebar_position":8,"title":"WebSocket Events"},"sidebar":"docsSidebar","previous":{"title":"Pages","permalink":"/project-code-battlegrounds-1-5/docs/internal-contracts/pages"},"next":{"title":"System Architecture","permalink":"/project-code-battlegrounds-1-5/docs/category/system-architecture"}}');var d=n(74848),c=n(28453);const t={sidebar_position:8,title:"WebSocket Events"},i="WebSocket Event Protocol",o={},l=[{value:"Shared Types",id:"shared-types",level:2},{value:"Client -&gt; Server Events",id:"client---server-events",level:2},{value:"<code>joinGame</code>",id:"joingame",level:3},{value:"<code>codeChange</code>",id:"codechange",level:3},{value:"<code>sendChat</code>",id:"sendchat",level:3},{value:"Server -&gt; Client Events",id:"server---client-events",level:2},{value:"<code>roleAssigned</code>",id:"roleassigned",level:3},{value:"<code>receiveCodeUpdate</code>",id:"receivecodeupdate",level:3},{value:"<code>receiveChat</code>",id:"receivechat",level:3},{value:"Connection Lifecycle",id:"connection-lifecycle",level:2},{value:"Server-Side State (Redis)",id:"server-side-state-redis",level:2},{value:"Error Handling",id:"error-handling",level:2}];function h(e){const s={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",mermaid:"mermaid",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",...(0,c.R)(),...e.components};return(0,d.jsxs)(d.Fragment,{children:[(0,d.jsx)(s.header,{children:(0,d.jsx)(s.h1,{id:"websocket-event-protocol",children:"WebSocket Event Protocol"})}),"\n",(0,d.jsxs)(s.p,{children:["Socket.IO, same origin as Next.js. Client connects with ",(0,d.jsx)(s.code,{children:"io()"})," (no args). Server defined in ",(0,d.jsx)(s.code,{children:"server.js"}),". Redis-backed for cluster-aware rooms and code state persistence."]}),"\n",(0,d.jsx)(s.hr,{}),"\n",(0,d.jsx)(s.h2,{id:"shared-types",children:"Shared Types"}),"\n",(0,d.jsx)(s.pre,{children:(0,d.jsx)(s.code,{className:"language-typescript",children:"type Role = 'coder' | 'tester' | 'spectator';\n\ninterface Message {\n  id: string;    // random short string, e.g. Math.random().toString(36).substring(7)\n  text: string;  // message body\n  user: string;  // sender's role label: \"Coder\" or \"Quality\"\n}\n"})}),"\n",(0,d.jsx)(s.hr,{}),"\n",(0,d.jsx)(s.h2,{id:"client---server-events",children:"Client -> Server Events"}),"\n",(0,d.jsx)(s.h3,{id:"joingame",children:(0,d.jsx)(s.code,{children:"joinGame"})}),"\n",(0,d.jsx)(s.p,{children:"Join a game room. Must be emitted immediately after connecting."}),"\n",(0,d.jsx)(s.pre,{children:(0,d.jsx)(s.code,{className:"language-typescript",children:"socket.emit('joinGame', gameId: string);\n"})}),"\n",(0,d.jsxs)(s.table,{children:[(0,d.jsx)(s.thead,{children:(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.th,{children:"Field"}),(0,d.jsx)(s.th,{children:"Type"}),(0,d.jsx)(s.th,{children:"Description"})]})}),(0,d.jsx)(s.tbody,{children:(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:(0,d.jsx)(s.code,{children:"gameId"})}),(0,d.jsx)(s.td,{children:(0,d.jsx)(s.code,{children:"string"})}),(0,d.jsxs)(s.td,{children:["The room identifier. Taken from the URL path ",(0,d.jsx)(s.code,{children:"/playGame/[gameID]"}),"."]})]})})]}),"\n",(0,d.jsx)(s.p,{children:(0,d.jsx)(s.strong,{children:"Server behavior:"})}),"\n",(0,d.jsxs)(s.ol,{children:["\n",(0,d.jsxs)(s.li,{children:["Adds the socket to the Socket.IO room ",(0,d.jsx)(s.code,{children:"gameId"}),"."]}),"\n",(0,d.jsxs)(s.li,{children:["Counts sockets in the room. Assigns role: 1st = ",(0,d.jsx)(s.code,{children:"coder"}),", 2nd = ",(0,d.jsx)(s.code,{children:"tester"}),", 3rd+ = ",(0,d.jsx)(s.code,{children:"spectator"}),"."]}),"\n",(0,d.jsxs)(s.li,{children:["Emits ",(0,d.jsx)(s.a,{href:"#roleassigned",children:(0,d.jsx)(s.code,{children:"roleAssigned"})})," back to this socket only."]}),"\n",(0,d.jsxs)(s.li,{children:["Reads ",(0,d.jsx)(s.code,{children:"game:{gameId}:code"})," from Redis. If non-null, emits ",(0,d.jsx)(s.a,{href:"#receivecodeupdate",children:(0,d.jsx)(s.code,{children:"receiveCodeUpdate"})})," to this socket only."]}),"\n"]}),"\n",(0,d.jsx)(s.hr,{}),"\n",(0,d.jsx)(s.h3,{id:"codechange",children:(0,d.jsx)(s.code,{children:"codeChange"})}),"\n",(0,d.jsxs)(s.p,{children:["Send updated code. Emitted by the coder on every keystroke (Monaco ",(0,d.jsx)(s.code,{children:"onChange"}),")."]}),"\n",(0,d.jsx)(s.pre,{children:(0,d.jsx)(s.code,{className:"language-typescript",children:"socket.emit('codeChange', {\n  roomId: string,  // same as gameId\n  code: string,    // full editor contents\n});\n"})}),"\n",(0,d.jsxs)(s.table,{children:[(0,d.jsx)(s.thead,{children:(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.th,{children:"Field"}),(0,d.jsx)(s.th,{children:"Type"}),(0,d.jsx)(s.th,{children:"Description"})]})}),(0,d.jsxs)(s.tbody,{children:[(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:(0,d.jsx)(s.code,{children:"roomId"})}),(0,d.jsx)(s.td,{children:(0,d.jsx)(s.code,{children:"string"})}),(0,d.jsx)(s.td,{children:"Room to broadcast to."})]}),(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:(0,d.jsx)(s.code,{children:"code"})}),(0,d.jsx)(s.td,{children:(0,d.jsx)(s.code,{children:"string"})}),(0,d.jsx)(s.td,{children:"Complete editor content (not a diff)."})]})]})]}),"\n",(0,d.jsx)(s.p,{children:(0,d.jsx)(s.strong,{children:"Server behavior:"})}),"\n",(0,d.jsxs)(s.ol,{children:["\n",(0,d.jsxs)(s.li,{children:["If ",(0,d.jsx)(s.code,{children:"roomId"})," is falsy, the event is silently dropped."]}),"\n",(0,d.jsxs)(s.li,{children:["Writes ",(0,d.jsx)(s.code,{children:"code"})," to Redis at key ",(0,d.jsx)(s.code,{children:"game:{roomId}:code"})," (no TTL)."]}),"\n",(0,d.jsxs)(s.li,{children:["Broadcasts ",(0,d.jsx)(s.a,{href:"#receivecodeupdate",children:(0,d.jsx)(s.code,{children:"receiveCodeUpdate"})})," to all other sockets in the room."]}),"\n"]}),"\n",(0,d.jsxs)(s.p,{children:[(0,d.jsx)(s.strong,{children:"Note:"})," This sends the full editor content on every keystroke. There is no debounce or diffing."]}),"\n",(0,d.jsx)(s.hr,{}),"\n",(0,d.jsx)(s.h3,{id:"sendchat",children:(0,d.jsx)(s.code,{children:"sendChat"})}),"\n",(0,d.jsx)(s.p,{children:"Send a chat message."}),"\n",(0,d.jsx)(s.pre,{children:(0,d.jsx)(s.code,{className:"language-typescript",children:"socket.emit('sendChat', {\n  roomId: string,\n  message: Message,\n});\n"})}),"\n",(0,d.jsxs)(s.table,{children:[(0,d.jsx)(s.thead,{children:(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.th,{children:"Field"}),(0,d.jsx)(s.th,{children:"Type"}),(0,d.jsx)(s.th,{children:"Description"})]})}),(0,d.jsxs)(s.tbody,{children:[(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:(0,d.jsx)(s.code,{children:"roomId"})}),(0,d.jsx)(s.td,{children:(0,d.jsx)(s.code,{children:"string"})}),(0,d.jsx)(s.td,{children:"Room to broadcast to."})]}),(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:(0,d.jsx)(s.code,{children:"message"})}),(0,d.jsx)(s.td,{children:(0,d.jsx)(s.code,{children:"Message"})}),(0,d.jsxs)(s.td,{children:["The chat message object (see ",(0,d.jsx)(s.a,{href:"#shared-types",children:"Shared Types"}),")."]})]})]})]}),"\n",(0,d.jsx)(s.p,{children:(0,d.jsx)(s.strong,{children:"Server behavior:"})}),"\n",(0,d.jsxs)(s.ol,{children:["\n",(0,d.jsxs)(s.li,{children:["If ",(0,d.jsx)(s.code,{children:"roomId"})," or ",(0,d.jsx)(s.code,{children:"message"})," is falsy, the event is silently dropped."]}),"\n",(0,d.jsxs)(s.li,{children:["Broadcasts ",(0,d.jsx)(s.a,{href:"#receivechat",children:(0,d.jsx)(s.code,{children:"receiveChat"})})," to all other sockets in the room."]}),"\n"]}),"\n",(0,d.jsxs)(s.p,{children:["Messages are ",(0,d.jsx)(s.strong,{children:"not persisted"})," server-side. Chat history only exists in each client's local React state."]}),"\n",(0,d.jsx)(s.hr,{}),"\n",(0,d.jsx)(s.h2,{id:"server---client-events",children:"Server -> Client Events"}),"\n",(0,d.jsx)(s.h3,{id:"roleassigned",children:(0,d.jsx)(s.code,{children:"roleAssigned"})}),"\n",(0,d.jsxs)(s.p,{children:["Tells the client what role they were assigned. Sent once, immediately after ",(0,d.jsx)(s.code,{children:"joinGame"}),"."]}),"\n",(0,d.jsx)(s.pre,{children:(0,d.jsx)(s.code,{className:"language-typescript",children:"socket.on('roleAssigned', (role: Role) => { ... });\n"})}),"\n",(0,d.jsxs)(s.table,{children:[(0,d.jsx)(s.thead,{children:(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.th,{children:"Field"}),(0,d.jsx)(s.th,{children:"Type"}),(0,d.jsx)(s.th,{children:"Values"})]})}),(0,d.jsx)(s.tbody,{children:(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:(0,d.jsx)(s.code,{children:"role"})}),(0,d.jsx)(s.td,{children:(0,d.jsx)(s.code,{children:"Role"})}),(0,d.jsxs)(s.td,{children:[(0,d.jsx)(s.code,{children:"'coder'"}),", ",(0,d.jsx)(s.code,{children:"'tester'"}),", or ",(0,d.jsx)(s.code,{children:"'spectator'"})]})]})})]}),"\n",(0,d.jsx)(s.p,{children:(0,d.jsx)(s.strong,{children:"Assignment logic:"})}),"\n",(0,d.jsxs)(s.table,{children:[(0,d.jsx)(s.thead,{children:(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.th,{children:"Sockets in room (after join)"}),(0,d.jsx)(s.th,{children:"Role"})]})}),(0,d.jsxs)(s.tbody,{children:[(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:"1"}),(0,d.jsx)(s.td,{children:(0,d.jsx)(s.code,{children:"coder"})})]}),(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:"2"}),(0,d.jsx)(s.td,{children:(0,d.jsx)(s.code,{children:"tester"})})]}),(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:"3+"}),(0,d.jsx)(s.td,{children:(0,d.jsx)(s.code,{children:"spectator"})})]})]})]}),"\n",(0,d.jsx)(s.hr,{}),"\n",(0,d.jsx)(s.h3,{id:"receivecodeupdate",children:(0,d.jsx)(s.code,{children:"receiveCodeUpdate"})}),"\n",(0,d.jsx)(s.p,{children:"Delivers code content. Sent in two situations:"}),"\n",(0,d.jsxs)(s.ol,{children:["\n",(0,d.jsxs)(s.li,{children:[(0,d.jsx)(s.strong,{children:"Broadcast"})," \u2014 when another socket in the room emits ",(0,d.jsx)(s.code,{children:"codeChange"})," (excludes sender)."]}),"\n",(0,d.jsxs)(s.li,{children:[(0,d.jsx)(s.strong,{children:"Unicast"})," \u2014 when a socket joins a room that already has code stored in Redis."]}),"\n"]}),"\n",(0,d.jsx)(s.pre,{children:(0,d.jsx)(s.code,{className:"language-typescript",children:"socket.on('receiveCodeUpdate', (code: string) => { ... });\n"})}),"\n",(0,d.jsxs)(s.table,{children:[(0,d.jsx)(s.thead,{children:(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.th,{children:"Field"}),(0,d.jsx)(s.th,{children:"Type"}),(0,d.jsx)(s.th,{children:"Description"})]})}),(0,d.jsx)(s.tbody,{children:(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:(0,d.jsx)(s.code,{children:"code"})}),(0,d.jsx)(s.td,{children:(0,d.jsx)(s.code,{children:"string"})}),(0,d.jsx)(s.td,{children:"Full editor content. Replaces whatever the receiver currently has."})]})})]}),"\n",(0,d.jsx)(s.hr,{}),"\n",(0,d.jsx)(s.h3,{id:"receivechat",children:(0,d.jsx)(s.code,{children:"receiveChat"})}),"\n",(0,d.jsx)(s.p,{children:"Delivers a chat message from another player in the room. Excludes the sender."}),"\n",(0,d.jsx)(s.pre,{children:(0,d.jsx)(s.code,{className:"language-typescript",children:"socket.on('receiveChat', (message: Message) => { ... });\n"})}),"\n",(0,d.jsxs)(s.table,{children:[(0,d.jsx)(s.thead,{children:(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.th,{children:"Field"}),(0,d.jsx)(s.th,{children:"Type"}),(0,d.jsx)(s.th,{children:"Description"})]})}),(0,d.jsx)(s.tbody,{children:(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:(0,d.jsx)(s.code,{children:"message"})}),(0,d.jsx)(s.td,{children:(0,d.jsx)(s.code,{children:"Message"})}),(0,d.jsxs)(s.td,{children:["See ",(0,d.jsx)(s.a,{href:"#shared-types",children:"Shared Types"}),"."]})]})})]}),"\n",(0,d.jsx)(s.hr,{}),"\n",(0,d.jsx)(s.h2,{id:"connection-lifecycle",children:"Connection Lifecycle"}),"\n",(0,d.jsx)(s.mermaid,{value:"sequenceDiagram\n    participant C as Client\n    participant S as Server\n    participant R as Redis\n\n    C->>S: connect (io())\n    C->>S: emit('joinGame', gameId)\n    S->>S: socket.join(gameId)\n    S->>S: io.in(gameId).allSockets() -> count\n    S--\x3e>C: emit('roleAssigned', role)\n    S->>R: GET game:{gameId}:code\n    alt code exists in Redis\n        R--\x3e>S: code\n        S--\x3e>C: emit('receiveCodeUpdate', code)\n    end\n\n    loop every keystroke (coder only)\n        C->>S: emit('codeChange', { roomId, code })\n        S->>R: SET game:{roomId}:code\n        S--\x3e>C: broadcast 'receiveCodeUpdate' to room (excl. sender)\n    end\n\n    loop on chat send\n        C->>S: emit('sendChat', { roomId, message })\n        S--\x3e>C: broadcast 'receiveChat' to room (excl. sender)\n    end\n\n    C->>S: disconnect\n    Note over S: socket auto-removed from all rooms"}),"\n",(0,d.jsx)(s.p,{children:"No reconnection logic exists. If the socket disconnects, the client does not attempt to re-join."}),"\n",(0,d.jsx)(s.hr,{}),"\n",(0,d.jsx)(s.h2,{id:"server-side-state-redis",children:"Server-Side State (Redis)"}),"\n",(0,d.jsxs)(s.table,{children:[(0,d.jsx)(s.thead,{children:(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.th,{children:"Key pattern"}),(0,d.jsx)(s.th,{children:"Value"}),(0,d.jsx)(s.th,{children:"Written by"}),(0,d.jsx)(s.th,{children:"Read by"}),(0,d.jsx)(s.th,{children:"TTL"})]})}),(0,d.jsx)(s.tbody,{children:(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:(0,d.jsx)(s.code,{children:"game:{roomId}:code"})}),(0,d.jsxs)(s.td,{children:[(0,d.jsx)(s.code,{children:"string"})," (full editor content)"]}),(0,d.jsxs)(s.td,{children:[(0,d.jsx)(s.code,{children:"codeChange"})," handler"]}),(0,d.jsxs)(s.td,{children:[(0,d.jsx)(s.code,{children:"joinGame"})," handler"]}),(0,d.jsx)(s.td,{children:"None"})]})})]}),"\n",(0,d.jsx)(s.p,{children:"No cleanup. Keys persist until Redis restart or eviction.\nTODO: This should probably change."}),"\n",(0,d.jsx)(s.hr,{}),"\n",(0,d.jsx)(s.h2,{id:"error-handling",children:"Error Handling"}),"\n",(0,d.jsxs)(s.table,{children:[(0,d.jsx)(s.thead,{children:(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.th,{children:"Scenario"}),(0,d.jsx)(s.th,{children:"Behavior"})]})}),(0,d.jsxs)(s.tbody,{children:[(0,d.jsxs)(s.tr,{children:[(0,d.jsxs)(s.td,{children:["Redis down during ",(0,d.jsx)(s.code,{children:"joinGame"})," code fetch"]}),(0,d.jsxs)(s.td,{children:[(0,d.jsx)(s.code,{children:"console.error"}),". Socket still joins the room and gets a role. No code sent."]})]}),(0,d.jsxs)(s.tr,{children:[(0,d.jsxs)(s.td,{children:["Redis down during ",(0,d.jsx)(s.code,{children:"codeChange"})," persist"]}),(0,d.jsxs)(s.td,{children:[(0,d.jsx)(s.code,{children:"console.error"}),". Code is still broadcast to the room, just not persisted for late joiners."]})]}),(0,d.jsxs)(s.tr,{children:[(0,d.jsxs)(s.td,{children:[(0,d.jsx)(s.code,{children:"roomId"})," missing on ",(0,d.jsx)(s.code,{children:"codeChange"})]}),(0,d.jsx)(s.td,{children:"Silently dropped."})]}),(0,d.jsxs)(s.tr,{children:[(0,d.jsxs)(s.td,{children:[(0,d.jsx)(s.code,{children:"roomId"})," or ",(0,d.jsx)(s.code,{children:"message"})," missing on ",(0,d.jsx)(s.code,{children:"sendChat"})]}),(0,d.jsx)(s.td,{children:"Silently dropped."})]}),(0,d.jsxs)(s.tr,{children:[(0,d.jsx)(s.td,{children:"Client disconnect"}),(0,d.jsx)(s.td,{children:"Logged. Socket.IO auto-removes the socket from all rooms. No app-level cleanup."})]})]})]})]})}function a(e={}){const{wrapper:s}={...(0,c.R)(),...e.components};return s?(0,d.jsx)(s,{...e,children:(0,d.jsx)(h,{...e})}):h(e)}}}]);